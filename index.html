<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Form ‡πÄ‡∏ä‡∏¥‡∏ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body {
    font-family: 'Inter', sans-serif;
    background: #f0f2f5;
}
.container {
    max-width: 900px;
    margin: 40px auto;
    padding: 30px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
h2 {
    text-align: center;
    margin-bottom: 30px;
    font-weight: 600;
    color: #333;
}
.employee-card {
    margin-bottom: 20px;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    padding: 20px;
    background: #fafafa;
    transition: transform 0.2s ease;
}
.employee-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.05);
}
label {
    font-weight: 500;
}
button {
    border-radius: 8px;
}
</style>
</head>
<body>
<div class="container">
    <h2>‡πÄ‡∏ä‡∏¥‡∏ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</h2>
    <form id="inviteForm">
        <div class="mb-3">
            <label class="form-label">Supplier:</label>
            <span id="supplierName" class="fw-bold"></span>
        </div>
        <div id="employeeList"></div>
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </form>
</div>

<script>
// ‡∏≠‡πà‡∏≤‡∏ô supplier ‡πÅ‡∏•‡∏∞ token ‡∏à‡∏≤‡∏Å URL
const urlParams = new URLSearchParams(window.location.search);
const supplier = urlParams.get('supplier') || '';
const token = urlParams.get('token') || '';
document.getElementById('supplierName').textContent = supplier;

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Backend
async function loadEmployees() {
    try {
        const res = await fetch(`https://kybt-systems.com/Authentication/api/get_employees?supplier=${encodeURIComponent(supplier)}&token=${encodeURIComponent(token)}`);
        const employees = await res.json();
        const container = document.getElementById('employeeList');
        container.innerHTML = '';

        if(employees.error){
            container.innerHTML = `<p class="text-danger">${employees.error}</p>`;
            return;
        }

        employees.forEach(emp => {
            const div = document.createElement('div');
            div.className = 'employee-card';
            div.innerHTML = `
                <p class="h5 fw-semibold">${emp.employee_name}</p>
                <div class="mb-3">
                    <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
                    <select name="status_${emp.id}" class="form-select" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                        <option value="OK">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</option>
                        <option value="substitute">‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô</option>
                        <option value="not">‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</option>
                    </select>
                </div>
                <div class="extraFields"></div>
            `;
            container.appendChild(div);

            const select = div.querySelector('select');
            const extraFields = div.querySelector('.extraFields');

            select.addEventListener('change', () => {
                const status = select.value;

                if(status === 'OK'){ // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                    extraFields.innerHTML = `
                        <div class="mb-3">
                            <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
                            <input type="email" name="email_${emp.id}" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                        </div>
                    `;
                } else if(status === 'substitute'){ // ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÅ‡∏ó‡∏ô
                    extraFields.innerHTML = `
                        <div class="mb-3">
                            <label class="form-label">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:</label>
                            <input type="text" name="prefix_${emp.id}" class="form-control" placeholder="‡∏ô‡∏≤‡∏¢/‡∏ô‡∏≤‡∏á/‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠:</label>
                            <input type="text" name="first_name_${emp.id}" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
                            <input type="text" name="last_name_${emp.id}" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
                            <input type="email" name="email_${emp.id}" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                        </div>
                    `;
                } else { // not ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                    extraFields.innerHTML = '';
                }
            });
        });

    } catch (error) {
        console.error(error);
        Swal.fire({
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ üò¢',
            icon: 'error',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        });
    }
}

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend
document.getElementById('inviteForm').addEventListener('submit', async e => {
    e.preventDefault();

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö validation ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
    const form = e.target;
    if(!form.checkValidity()){
        form.reportValidity();
        return;
    }

    const formData = new FormData();
    formData.append('supplier', supplier);
    formData.append('token', token);

    document.querySelectorAll('.employee-card').forEach(card => {
        const empId = card.querySelector('select').name.split('_')[1];
        const status = card.querySelector('select').value;
        formData.append(`status_${empId}`, status);

        card.querySelectorAll('input').forEach(input => {
            formData.append(input.name, input.value);
        });
    });

    try {
        const res = await fetch('https://kybt-systems.com/Authentication/api/save_invite', {
            method: 'POST',
            body: formData
        });
        const result = await res.json();

        if(result.status === 'ok') {
            Swal.fire({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß üéâ',
                icon: 'success',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            });
        } else {
            Swal.fire({
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                text: result.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏',
                icon: 'error',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            });
        }
    } catch (err) {
        console.error(err);
        Swal.fire({
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ üò¢',
            icon: 'error',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        });
    }
});

loadEmployees();
</script>

<!-- Bootstrap 5 JS + Popper (optional) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
