<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-Form KYB Thailand</title>
<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="https://kybt-systems.com/favicon.ico" />
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body {
    font-family: 'Inter', sans-serif;
    background: #f0f2f5;
}
.container {
    max-width: 900px;
    margin: 40px auto;
    padding: 30px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
h2, h3 {
    text-align: center;
    font-weight: 600;
    color: #333;
}
.employee-card {
    margin-bottom: 20px;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    padding: 20px;
    background: #fafafa;
}
button {
    border-radius: 8px;
}
.logo {
    display: block;
    margin: 0 auto 20px;
    width: 300px;
}
.agenda-card {
    background: #fafafa;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
}
.step {
    display: none;
}
.step.active {
    display: block;
}
</style>
</head>
<body style="background-image: url('b1.jpg'); background-size: cover; background-position: unset;background-attachment:fixed">
<div class="container">

    <!-- STEP 1: Invitation Card -->
    <div id="step1" class="step active">
        <img src="logo.jpg" alt="Logo" class="logo">
        <h2>Invitation to Supplier Annual Meeting 2025</h2>
        <div class="agenda-card mt-4">
            <h5>Event Details</h5>
            <p><strong>Date & Time:</strong> 15 November 2025, 09:00 AM</p>
            <p><strong>Location:</strong> Main Conference Room, Head Office</p>
            <p><strong>Main Agenda:</strong> Discuss and summarize annual plans, and hear the organization's development direction for 2026</p>
        </div>
        <div class="text-center mt-4">
            <button id="nextToStep2" class="btn btn-primary btn-lg">Next</button>
        </div>
    </div>

    <!-- STEP 2: Employee Form -->
    <div id="step2" class="step">
        <h2>Form</h2>
        <form id="inviteForm">
            <div class="mb-3">
                <label class="form-label">Supplier:</label>
                <span id="supplierName" class="fw-bold"></span>
            </div>
            <div id="employeeList"></div>
            <div class="d-flex justify-content-between mt-4">
                <button type="button" id="backToStep1" class="btn btn-secondary btn-lg">Back</button>
                <button type="submit" class="btn btn-primary btn-lg">Submit</button>
            </div>
        </form>
    </div>

    <!-- STEP 3: Success Page -->
    <div id="step3" class="step text-center">
        <img src="logo.jpg" alt="Logo" class="logo">
        <h2 class="text-success">Thank you for your RSVP 🎉</h2>
        <p>Your information has been successfully submitted.</p>
        <div class="agenda-card mt-4 text-start">
            <h5>Event Details</h5>
            <p><strong>Date & Time:</strong> 15 November 2025, 09:00 AM</p>
            <p><strong>Location:</strong> Main Conference Room, Head Office</p>
            <p><strong>Main Agenda:</strong> Discuss and summarize annual plans, and hear the organization's development direction for 2026</p>
        </div>
    </div>

</div>

<script>
// Get supplier and token from URL
const urlParams = new URLSearchParams(window.location.search);
const supplier = urlParams.get('supplier') || '';
const token = urlParams.get('token') || '';


// Function to switch steps
function showStep(step) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(step).classList.add('active');
}

// Navigation buttons
document.getElementById('nextToStep2').addEventListener('click', () => showStep('step2'));
document.getElementById('backToStep1').addEventListener('click', () => showStep('step1'));

// Load employees from API
async function loadEmployees() {
    try {
        const res = await fetch(`https://kybt-systems.com/Authentication/api/get_employees?supplier=${encodeURIComponent(supplier)}&token=${encodeURIComponent(token)}`);
        const employees = await res.json();
        const container = document.getElementById('employeeList');
        container.innerHTML = '';

        if(employees.error){
            container.innerHTML = `<p class="text-danger">${employees.error}</p>`;
            return;
        }

        
        document.getElementById('supplierName').textContent = employees[0]['supplier_name'];
        

        employees.forEach(emp => {
            const div = document.createElement('div');
            div.className = 'employee-card';
            div.innerHTML = `
                <p class="h5 fw-semibold">${emp.employee_name} ${emp.employee_lastname}</p>
                <div class="mb-3">
                   <label class="form-label">Participation Status</label>
                    <select name="status_${emp.id}" class="form-select" required>
                        <option value="">-- Select --</option>
                        <option value="1">Will Attend</option>
                        <option value="2">Has Substitute</option>
                        <option value="3">Will Not Attend</option>
                    </select>
                </div>
                <div class="extraFields"></div>
            `;
            container.appendChild(div);

            const select = div.querySelector('select');
            const extraFields = div.querySelector('.extraFields');

            select.addEventListener('change', () => {
                const status = select.value;
                if(status === '1'){ // Will Attend
                    extraFields.innerHTML = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email:</label>
                                <input type="email" name="email_${emp.id}" class="form-control"  required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Position:</label>
                                <input type="text" name="position_${emp.id}" class="form-control"  required>
                            </div>
                        </div>
                    `;
                } else if(status === '2'){ // Has Substitute
                    extraFields.innerHTML = `
                        <div class="row">
                                <div class="col-md-3 mb-3">
                                <label class="form-label">Prefix</label>
                                <select name="prefix_${emp.id}" class="form-select" required>
                                    <option value="">-- Select --</option>
                                    <option value="Mr.">Mr.</option>
                                    <option value="Mrs.">Mrs.</option>
                                    <option value="Ms.">Ms.</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">First Name:</label>
                                <input type="text" name="first_name_${emp.id}" class="form-control"  required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Last Name:</label>
                                <input type="text" name="last_name_${emp.id}" class="form-control"  required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Email:</label>
                                <input type="email" name="email_${emp.id}" class="form-control"  required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Position:</label>
                            <input type="text" name="position_${emp.id}" class="form-control"  required>
                        </div>
                    `;
                } else {
                    extraFields.innerHTML = '';
                }
            });
        });
    } catch (error) {
        console.error(error);
        Swal.fire({
            title: 'Error',
            text: 'Failed to load employee data 😢',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
}

// Submit form
document.getElementById('inviteForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;

    // ✅ Disable submit button to prevent multiple clicks
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    if(!form.checkValidity()){
        form.reportValidity();
        // ถ้า form ไม่ valid กลับ enable ปุ่ม
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
        return;
    }

    const formData = new FormData();
    const supplierNameNew = document.getElementById('supplierName').textContent;
    formData.append('supplier', supplier);
    formData.append('token', token);
    formData.append('supplierName', supplierNameNew);

    

    document.querySelectorAll('.employee-card').forEach(card => {
        const empId = card.querySelector('select').name.split('_')[1];
        const status = card.querySelector('select').value;
        formData.append(`status_${empId}`, status);
        card.querySelectorAll('input').forEach(input => formData.append(input.name, input.value));
    });

    try {
        const res = await fetch('https://kybt-systems.com/Authentication/api/save_invite', {
            method: 'POST',
            body: formData
        });
        const result = await res.json();

        if(result.status === 'ok') {
            showStep('step3');
        } else {
            Swal.fire({
                title: 'Error',
                text: result.message || 'Unknown error',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            // ถ้าเกิด error กลับ enable ปุ่ม
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
        }
    } catch (err) {
        console.error(err);
        Swal.fire({
            title: 'Error',
            text: 'Failed to submit data 😢',
            icon: 'error',
            confirmButtonText: 'OK'
        });
        // ถ้าเกิด error กลับ enable ปุ่ม
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
    }
});


loadEmployees();
</script>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
