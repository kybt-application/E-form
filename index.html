<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Form เชิญพนักงาน</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4;}
.container { max-width: 900px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 10px; }
h2 { text-align: center; margin-bottom: 20px; }
.employee { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
.employee label { display: block; margin: 5px 0; }
input[type="email"], select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
button { padding: 10px 20px; background: #007BFF; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
button:hover { background: #0056b3; }
@media(max-width:600px){ .container{padding:10px;} }
</style>
</head>
<body>
<div class="container">
    <h2>Form เชิญพนักงาน</h2>
    <form id="inviteForm">
        <div>
            <label>Supplier:</label>
            <span id="supplierName"></span>
        </div>
        <div id="employeeList"></div>
        <button type="submit">ส่งข้อมูล</button>
    </form>
</div>

<script>
// อ่าน supplier และ token จาก URL
const urlParams = new URLSearchParams(window.location.search);
const supplier = urlParams.get('supplier') || '';
const token = urlParams.get('token') || '';
document.getElementById('supplierName').textContent = supplier;

// ดึงข้อมูลพนักงานจาก Backend
async function loadEmployees() {
    try {
        const res = await fetch(`https://kybt-systems.com/api/get_employees?supplier=${encodeURIComponent(supplier)}&token=${encodeURIComponent(token)}`);
        const employees = await res.json();
        const container = document.getElementById('employeeList');
        container.innerHTML = '';

        if(employees.error){
            container.innerHTML = `<p style="color:red;">${employees.error}</p>`;
            return;
        }

        employees.forEach(emp => {
            const div = document.createElement('div');
            div.className = 'employee';
            div.innerHTML = `
                <p><strong>${emp.employee_name}</strong></p>
                <label>สถานะ:</label>
                <select name="status_${emp.id}" required>
                    <option value="">-- เลือก --</option>
                    <option value="attend">เข้าร่วม</option>
                    <option value="substitute">มีคนแทน</option>
                    <option value="not">ไม่เข้าร่วม</option>
                </select>
                <label>อีเมล:</label>
                <input type="email" name="email_${emp.id}" placeholder="กรอกอีเมล" required>
            `;
            container.appendChild(div);
        });

    } catch (error) {
        console.error(error);
        alert('เกิดข้อผิดพลาดในการโหลดข้อมูลพนักงาน');
    }
}

// ส่งข้อมูลไป Backend
document.getElementById('inviteForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    formData.append('supplier', supplier);
    formData.append('token', token);

    try {
        const res = await fetch('https://kybt-systems.com/api/save_invite', {
            method: 'POST',
            body: formData
        });
        const result = await res.json();
        if(result.status === 'ok'){
            alert('บันทึกข้อมูลเรียบร้อยแล้ว');
            window.location.reload();
        } else {
            alert('เกิดข้อผิดพลาด: ' + (result.message || 'ไม่ทราบสาเหตุ'));
        }
    } catch (error) {
        console.error(error);
        alert('เกิดข้อผิดพลาดในการส่งข้อมูล');
    }
});

loadEmployees();
</script>
</body>
</html>
