<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-Form KYB Thailand</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="https://kybt-systems.com/favicon.ico" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body {
    font-family: 'Inter', sans-serif;
    background: #f0f2f5;
}
.container {
    max-width: 900px;
    margin: 40px auto;
    padding: 30px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
h2, h3 {
    text-align: center;
    font-weight: 600;
    color: #333;
}
button { border-radius: 8px; }
.logo {
    display: block;
    margin: 0 auto 20px;
    width: 300px;
}
.agenda-card {
    background: #fafafa;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
}
.employee-card {
    background: #fafafa;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    position: relative;
}
.btn-remove {
    position: absolute;
    top: 15px;
    right: 15px;
}
.step { display: none; }
.step.active { display: block; }
</style>
</head>
<body style="background-image: url('b1.jpg'); background-size: cover; background-attachment: fixed">

<div class="container">

    <!-- STEP 1 -->
    <div id="step1" class="step active">
        <img src="logo.jpg" alt="Logo" class="logo">
         <h2>Invitation to the 30th Anniversary Celebration of KYB (Thailand) Co., Ltd.</h2>
          <div class="agenda-card mt-4">
            <h5>Event Details</h5><br>
            <p><strong>Date & Time:</strong> Tuesday 27 January, 2026 <br> 06:00 â€“ 09:00 pm </p>
            <p><strong>Location:</strong> Siam Patumwan House 414, Phayathai Road, Wang Mai, Pathumwan, Bangkok 10330, Thailand</p>
            <!-- <p><strong>Main Agenda:</strong> Discuss and summarize annual plans, and hear the organization's development direction for 2026</p> -->
        </div>
        <div class="text-center mt-4">
            <button id="nextToStep2" class="btn btn-primary btn-lg">Next</button>
        </div>
    </div>
        <!-- STEP 2 -->
    <div id="step2" class="step">
        <h2>Invitation to the 30th Anniversary Celebration of KYB (Thailand) Co., Ltd. (Form)</h2>
        <form id="inviteForm">
            <div class="mb-3">
                <label class="form-label" id="supplier_new"></label>
                <span id="supplierName" class="fw-bold"></span>
            </div>

            <div id="employeeContainer"></div>

            <div class="text-center mb-3">
                <button type="button" id="btnAddEmployee" class="btn btn-outline-primary btn-sm">âž• Add Participation </button>
                <p class="text-muted mt-2" id="countInfo"></p>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="button" id="backToStep1" class="btn btn-secondary btn-lg">back</button>
                <button type="submit" class="btn btn-primary btn-lg">Submit</button>
            </div>
        </form>
    </div>


    <!-- STEP 3 -->
<div id="step3" class="step text-center">
        <img src="logo.jpg" alt="Logo" class="logo">
        <h2 class="text-success">Thank you for your RSVP ðŸŽ‰</h2>
        <p>Your information has been successfully submitted.</p>
         <div class="agenda-card mt-4">
            <h5>Event Details</h5><br>
            <p><strong>Date & Time:</strong> Tuesday 27 January, 2026 - 06:00 â€“ 09:00 pm </p>
            <p><strong>Location:</strong> Siam Patumwan House 414, Phayathai Road, Wang Mai, Pathumwan, Bangkok 10330, Thailand</p>
            <!-- <p><strong>Main Agenda:</strong> Discuss and summarize annual plans, and hear the organization's development direction for 2026</p> -->
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
const urlParams = new URLSearchParams(window.location.search);
const supplier = urlParams.get('supplier') || '';
const token = urlParams.get('token') || '';

let totalEmployees = 1; 
let currentCount = 0;

// ===================
// Show step
// ===================
function showStep(step) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(step).classList.add('active');
}

document.getElementById('nextToStep2').addEventListener('click', () => showStep('step2'));
document.getElementById('backToStep1').addEventListener('click', () => showStep('step1'));

// ===================
// Load supplier & main representative
// ===================
async function loadSupplierInfo() {
    try {
        const res = await fetch(`https://kybt-systems.com/Authentication/api/get_employees?supplier=${encodeURIComponent(supplier)}&token=${encodeURIComponent(token)}`);
        const data = await res.json();
        if (data.error) {
            Swal.fire({ icon: 'error', title: 'Error', text: data.error });
            return;
        }
        document.getElementById('supplierName').textContent = data[0]['supplier_name'];
        document.getElementById("supplier_new").textContent = data[0]['employee_type'] + " :";

        totalEmployees = data.length || 1; 
        if (data.length > 0) addEmployeeCard(data[0].employee_name + " " + data[0].employee_lastname, true); 
        updateCountInfo();
    } catch (err) {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'Failed to load data' });
    }
}

// ===================
// Update employee order
// ===================
function updateEmployeeOrder() {
    const cards = document.querySelectorAll('#employeeContainer .employee-card');
    let index = 0;

    cards.forEach(card => {
        index++;
        card.dataset.index = index;
        const header = card.querySelector('h5');

        if (index === 1) {
            header.textContent = 'Main Representative';
        } else {
            header.textContent = `Participant #${index}`;
        }

        const fields = card.querySelectorAll('.participant-field');
        fields.forEach(field => {
            const fieldName = field.dataset.field; 
            if(fieldName){ 
                field.setAttribute('name', `${fieldName}_${index}`);
            }
        });
    });
}

// ===================
// Add employee card
// ===================
function addEmployeeCard(name = '', isMain = false) {
    if (!isMain && currentCount >= totalEmployees) {
        Swal.fire({ icon: 'info', title: 'Limit reached', text: 'You cannot add more participants than allowed.' });
        return;
    }

    currentCount++;
    const container = document.getElementById('employeeContainer');
    const div = document.createElement('div');
    div.className = 'employee-card';

    if (isMain) {
        const id = 1;
        div.dataset.index = id;
        div.innerHTML = `
            <h5>Main Representative</h5>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Prefix</label>
                    <select name="prefix_${id}" class="form-select participant-field" data-field="prefix" required>
                        <option value="">-- Select --</option>
                        <option value="Mr.">Mr.</option>
                        <option value="Mrs.">Mrs.</option>
                        <option value="Ms.">Ms.</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">First Name</label>
                    <input type="text" name="first_name_${id}" class="form-control participant-field" data-field="first_name" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Last Name</label>
                    <input type="text" name="last_name_${id}" class="form-control participant-field" data-field="last_name" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" name="email_${id}" class="form-control participant-field" data-field="email" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Position</label>
                    <input type="text" name="position_${id}" class="form-control participant-field" data-field="position" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Company Name</label>
                    <input type="text" name="company_name_${id}" class="form-control participant-field" data-field="company_name" required>
                </div>
            </div>
            <input type="hidden" name="status_${id}" value="1" class="participant-field" data-field="status">
        `;
    } else {
        div.innerHTML = `
            <button type="button" class="btn btn-danger btn-sm btn-remove">ðŸ—‘ Remove</button>
            <h5>Participant #</h5>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Prefix</label>
                    <select class="form-select participant-field" data-field="prefix" required>
                        <option value="">-- Select --</option>
                        <option value="Mr.">Mr.</option>
                        <option value="Mrs.">Mrs.</option>
                        <option value="Ms.">Ms.</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-control participant-field" data-field="first_name" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-control participant-field" data-field="last_name" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control participant-field" data-field="email" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Position</label>
                    <input type="text" class="form-control participant-field" data-field="position" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Company Name</label>
                    <input type="text" class="form-control participant-field" data-field="company_name" required>
                </div>
            </div>
            <input type="hidden" class="participant-field" data-field="status" value="1">
        `;
        div.querySelector('.btn-remove').addEventListener('click', () => {
            div.remove();
            currentCount--;
            updateEmployeeOrder();
            updateCountInfo();
        });
    }

    container.appendChild(div);
    updateEmployeeOrder();
    updateCountInfo();
}

// ===================
// Update count info
// ===================
function updateCountInfo() {
    document.getElementById('countInfo').textContent = `Filled ${currentCount} of ${totalEmployees} participants`;
}

document.getElementById('btnAddEmployee').addEventListener('click', () => addEmployeeCard());

// ===================
// Submit form
// ===================
document.getElementById('inviteForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');

    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    document.querySelectorAll('#employeeContainer .employee-card').forEach(card => {
        const select = card.querySelector('select[name="status_main"]');
        if(select) select.dispatchEvent(new Event('change'));
    });
    
    setTimeout(async () => {
        const formData = new FormData();
        const supplierNameNew = document.getElementById('supplierName').textContent;
        formData.append('supplier', supplier);
        formData.append('token', token);
        formData.append('supplierName', supplierNameNew);
        
        const cards = document.querySelectorAll('#employeeContainer .employee-card');
        cards.forEach(card => {
            const inputs = card.querySelectorAll('input[name], select[name]');
            inputs.forEach(input => {
                const name = input.name;
                let value = input.value;
                if (name) formData.append(name, value);
            });
        });
        
        console.log("--- FINAL PAYLOAD ---");
        for (var pair of formData.entries()) console.log(pair[0]+ ': ' + pair[1]);

        try {
            const res = await fetch('https://kybt-systems.com/Authentication/api/save_invite_solution_2', {
                method: 'POST',
                body: formData
            });
            
            const result = await res.json();
            if (result.status === 'ok') {
                showStep('step3');
            } else {
                Swal.fire({ icon: 'error', title: 'Submission failed', text: result.message || 'Unknown error' });
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        } catch (err) {
            console.error(err);
            Swal.fire({ icon: 'error', title: 'Unable to submit data' });
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
        }
    }, 100); 
});

loadSupplierInfo();
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
