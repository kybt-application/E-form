<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-Form KYB Thailand (Solution 2 Final)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="https://kybt-systems.com/favicon.ico" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body {
    font-family: 'Inter', sans-serif;
    background: #f0f2f5;
}
.container {
    max-width: 900px;
    margin: 40px auto;
    padding: 30px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
h2, h3 {
    text-align: center;
    font-weight: 600;
    color: #333;
}
button { border-radius: 8px; }
.logo {
    display: block;
    margin: 0 auto 20px;
    width: 300px;
}
.agenda-card {
    background: #fafafa;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
}
.employee-card {
    background: #fafafa;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    position: relative;
}
.btn-remove {
    position: absolute;
    top: 15px;
    right: 15px;
}
.step { display: none; }
.step.active { display: block; }
</style>
</head>
<body style="background-image: url('b1.jpg'); background-size: cover; background-attachment: fixed">

<div class="container">

    <!-- STEP 1 -->
    <div id="step1" class="step active">
        <img src="logo.jpg" alt="Logo" class="logo">
        <h2>Invitation to Supplier Annual Meeting 2025</h2>
        <div class="agenda-card mt-4">
            <h5>Event Details</h5>
            <p><strong>Date & Time:</strong> 15 November 2025, 09:00 AM</p>
            <p><strong>Location:</strong> Main Conference Room, Head Office</p>
            <p><strong>Main Agenda:</strong> Discuss and summarize annual plans, and hear the organization's development direction for 2026</p>
        </div>
        <div class="text-center mt-4">
            <button id="nextToStep2" class="btn btn-primary btn-lg">Next</button>
        </div>
    </div>
        <!-- STEP 2 -->
    <div id="step2" class="step">
        <h2>Form</h2>
        <form id="inviteForm">
            <div class="mb-3">
                <label class="form-label">Supplier:</label>
                <span id="supplierName" class="fw-bold"></span>
            </div>

            <div id="employeeContainer"></div>

            <div class="text-center mb-3">
                <button type="button" id="btnAddEmployee" class="btn btn-outline-primary btn-sm">‚ûï Add Participation </button>
                <p class="text-muted mt-2" id="countInfo"></p>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="button" id="backToStep1" class="btn btn-secondary btn-lg">back</button>
                <button type="submit" class="btn btn-primary btn-lg">Submit</button>
            </div>
        </form>
    </div>


    <!-- STEP 3 -->
<div id="step3" class="step text-center">
        <img src="logo.jpg" alt="Logo" class="logo">
        <h2 class="text-success">Thank you for your RSVP üéâ</h2>
        <p>Your information has been successfully submitted.</p>
        <div class="agenda-card mt-4 text-start">
            <h5>Event Details</h5>
            <p><strong>Date & Time:</strong> 15 November 2025, 09:00 AM</p>
            <p><strong>Location:</strong> Main Conference Room, Head Office</p>
            <p><strong>Main Agenda:</strong> Discuss and summarize annual plans, and hear the organization's development direction for 2026</p>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
const urlParams = new URLSearchParams(window.location.search);
const supplier = urlParams.get('supplier') || '';
const token = urlParams.get('token') || '';
// document.getElementById('supplierName').textContent = supplier;

let totalEmployees = 1; 
let currentCount = 0;

// ===================
// Show step
// ===================
function showStep(step) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(step).classList.add('active');
}

document.getElementById('nextToStep2').addEventListener('click', () => showStep('step2'));
document.getElementById('backToStep1').addEventListener('click', () => showStep('step1'));

// ===================
// Load supplier & main representative
// ===================
async function loadSupplierInfo() {
    try {
        const res = await fetch(`https://kybt-systems.com/Authentication/api/get_employees?supplier=${encodeURIComponent(supplier)}&token=${encodeURIComponent(token)}`);
        const data = await res.json();
        if (data.error) {
            Swal.fire({ icon: 'error', title: 'Error', text: data.error });
            return;
        }
        //  console.log(data);
         document.getElementById('supplierName').textContent = data[0]['supplier_name'];

        totalEmployees = data.length || 1; 
        if (data.length > 0) addEmployeeCard(data[0].employee_name + " " + data[0].employee_lastname, true); 
        updateCountInfo();
    } catch (err) {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'Failed to load data' });
    }

   
}

// ===================
// Update order after remove & Set correct name attributes
// (‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô addEmployeeCard)
// ===================
function updateEmployeeOrder() {
    const cards = document.querySelectorAll('#employeeContainer .employee-card');
    let index = 0;

    cards.forEach(card => {
        index++;
        card.dataset.index = index;
        const header = card.querySelector('h5');

        if (index === 1) {
            header.textContent = 'Main Representative';
        } else {
            header.textContent = `Participant #${index}`;
        }

        // üí° ‡∏Å‡∏≥‡∏´‡∏ô‡∏î name attribute ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö input/select ‡∏ó‡∏µ‡πà‡∏°‡∏µ data-field 
        const fields = card.querySelectorAll('.participant-field');
        fields.forEach(field => {
            const fieldName = field.dataset.field; 
            if(fieldName){ 
                field.setAttribute('name', `${fieldName}_${index}`);
            }
        });
    });
}


// ===================
// Add employee card - Main Representative (ID 1)
// ===================
function addEmployeeCard(name = '', isMain = false) {
    if (!isMain && currentCount >= totalEmployees) {
        Swal.fire({ icon: 'info', title: 'Limit reached', text: 'You cannot add more participants than allowed.' });
        return;
    }

    currentCount++;
    const container = document.getElementById('employeeContainer');
    const div = document.createElement('div');
    div.className = 'employee-card';
    
    if (isMain) {
        const id = 1; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠ ID 1 ‡πÄ‡∏™‡∏°‡∏≠
        div.dataset.index = id;
        div.innerHTML = `
            <h5>Main Representative</h5>
            <p class="text-muted">${name}</p>
            <div class="mb-3">
                <label class="form-label">Participation Status</label>
                <select name="status_${id}" class="form-select" required data-field="status">
                    <option value="">-- Select Status --</option>
                    <option value="1">Will Attend</option>
                    <option value="2">Substitute</option>
                    <option value="3">Will Not Attend</option>
                </select>
            </div>
            <div class="extraFields"></div>
        `;
        const select = div.querySelector('select');
        const extraFields = div.querySelector('.extraFields');

        // üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ updateEmployeeOrder()
        select.addEventListener('change', () => {
            const status = select.value;
            if (status === '1') {
                extraFields.innerHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email_1" class="form-control participant-field" data-field="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Position</label>
                            <input type="text" name="position_1" class="form-control participant-field" data-field="position" required>
                        </div>
                    </div>
                `;
            } else if (status === '2') {
                extraFields.innerHTML = `
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Prefix</label>
                            <select name="prefix_1" class="form-select participant-field" data-field="prefix" required>
                                <option value="">-- Select --</option>
                                <option value="Mr.">Mr.</option>
                                <option value="Mrs.">Mrs.</option>
                                <option value="Ms.">Ms.</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">First Name</label>
                            <input type="text" name="first_name_1" class="form-control participant-field" data-field="first_name" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" name="last_name_1" class="form-control participant-field" data-field="last_name" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email_1" class="form-control participant-field" data-field="email" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Position</label>
                        <input type="text" name="position_1" class="form-control participant-field" data-field="position" required>
                    </div>
                `;
            } else {
                extraFields.innerHTML = '';
            }

            // üö® ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateEmployeeOrder ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô DOM
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ name attribute ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ß‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            updateEmployeeOrder(); 
        });
        
    } else {
        // ... ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Participant (ID > 1) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        div.innerHTML = `
            <button type="button" class="btn btn-danger btn-sm btn-remove">üóë Remove</button>
            <h5>Participant #</h5>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Prefix</label>
                    <select name="" class="form-select participant-field" data-field="prefix" required>
                        <option value="">-- Select --</option>
                        <option value="Mr.">Mr.</option>
                        <option value="Mrs.">Mrs.</option>
                        <option value="Ms.">Ms.</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">First Name</label>
                    <input type="text" name="" class="form-control participant-field" data-field="first_name" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Last Name</label>
                    <input type="text" name="" class="form-control participant-field" data-field="last_name" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" name="" class="form-control participant-field" data-field="email" required>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Position</label>
                <input type="text" name="" class="form-control participant-field" data-field="position" required>
            </div>
            <input type="hidden" name="" class="participant-field" data-field="status" value="1">
        `;
        div.querySelector('.btn-remove').addEventListener('click', () => {
            div.remove();
            currentCount--;
            updateEmployeeOrder();
            updateCountInfo();
        });
    }

    container.appendChild(div);
    updateEmployeeOrder(); // üí° ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Card ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    updateCountInfo();
}


// ===================
// Update count info
// ===================
function updateCountInfo() {
    document.getElementById('countInfo').textContent = `Filled ${currentCount} of ${totalEmployees} participants`;
}

document.getElementById('btnAddEmployee').addEventListener('click', () => addEmployeeCard());


// ===================
// Submit form - FINAL FIX
// ===================
document.getElementById('inviteForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');

    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    // üö® 1. Trigger change event ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå Dynamic ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
    // (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å status ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    document.querySelectorAll('#employeeContainer .employee-card').forEach(card => {
        const select = card.querySelector('select[name="status_main"]'); // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
        if(select) select.dispatchEvent(new Event('change'));
    });
    
    // üí• 2. ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 100ms ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DOM ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå Dynamic
    setTimeout(async () => {
        
        // üí° 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á FormData ‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠
        const formData = new FormData();
        const supplierNameNew = document.getElementById('supplierName').textContent;
        formData.append('supplier', supplier);
        formData.append('token', token);
        formData.append('supplierName', supplierNameNew);
        
        const cards = document.querySelectorAll('#employeeContainer .employee-card');

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å Card
        cards.forEach((card, index) => {
            // üåü 4. ‡∏î‡∏∂‡∏á input/select ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ name attribute ‡∏à‡∏≤‡∏Å Card ‡∏ô‡∏±‡πâ‡∏ô‡πÜ
            // ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á:
            // - ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡∏á‡∏ó‡∏µ‡πà: status_main, email_main, position_main, etc.
            // - ‡∏ü‡∏¥‡∏•‡∏î‡πå Dynamic: prefix_2, email_2, position_2, etc.
            const inputs = card.querySelectorAll('input[name], select[name]');
            
            inputs.forEach(input => {
                const name = input.name;
                let value = input.value;
                
                if (name) { 
                    formData.append(name, value);
                }
            });
        });
        
        // üö® DEBUG STEP: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        console.log("--- FINAL PAYLOAD (Fixed Names Verification) ---");
        for (var pair of formData.entries()) {
            console.log(pair[0]+ ': ' + pair[1]); 
        }
        console.log("--- END PAYLOAD ---");

        try {
            const res = await fetch('https://kybt-systems.com/Authentication/api/save_invite_solution_2', {
                method: 'POST',
                body: formData
            });
            
            const result = await res.json();
            if (result.status === 'ok') {
                showStep('step3');
            } else {
                Swal.fire({ icon: 'error', title: 'Submission failed', text: result.message || 'Unknown error' });
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        } catch (err) {
            console.error(err);
            Swal.fire({ icon: 'error', title: 'Unable to submit data' });
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit';
        }
    }, 100); 
});


// ===================
// Load main representative on page load
// ===================
loadSupplierInfo();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
